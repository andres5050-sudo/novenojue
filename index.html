<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Leyes de Newton: Fuerza y Movimiento</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e74c3c 0%, #3498db 50%, #9b59b6 100%);
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: pan-x pan-y;
            animation: backgroundShift 15s ease infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { background: linear-gradient(135deg, #e74c3c 0%, #3498db 50%, #9b59b6 100%); }
            50% { background: linear-gradient(135deg, #3498db 0%, #9b59b6 50%, #e74c3c 100%); }
        }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; width: 95%; }

        .slide { display: none; animation: slideIn 0.5s ease-in-out; min-height: 100vh; }
        .slide.active { display: flex; flex-direction: column; justify-content: center; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .slide-content {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            padding: 35px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.5);
        }

        h1 {
            color: transparent;
            background: linear-gradient(135deg, #e74c3c 0%, #3498db 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 3.8em;
            margin-bottom: 25px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            animation: titlePulse 3s ease-in-out infinite;
        }

        @keyframes titlePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        h2 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 25px;
            border-bottom: 4px solid transparent;
            border-image: linear-gradient(90deg, #e74c3c 0%, #3498db 100%);
            border-image-slice: 1;
            padding-bottom: 12px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }

        h3 {
            color: #e74c3c;
            font-size: 1.8em;
            margin: 25px 0 15px 0;
            font-weight: bold;
        }

        p { line-height: 1.9; color: #333; margin-bottom: 18px; font-size: 1.15em; }

        .nav-buttons { display: flex; justify-content: space-between; margin-top: 35px; gap: 25px; }

        button {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before { width: 300px; height: 300px; }

        button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.6);
        }

        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .intro-slide { text-align: center; }

        .intro-slide h1 {
            font-size: 5em;
            margin-bottom: 35px;
            animation: titlePulse 2s infinite, colorShift 5s infinite;
        }

        @keyframes colorShift {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(30deg); }
        }

        .force-icon {
            font-size: 7em;
            margin: 25px 0;
            animation: bounce 2s ease-in-out infinite, rotate 4s linear infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-30px) rotate(180deg); }
        }

        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        #gameCanvas {
            border: 4px solid #e74c3c;
            border-radius: 15px;
            display: block;
            margin: 25px auto;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            width: 100%;
            max-width: 900px;
            height: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), inset 0 0 30px rgba(52, 152, 219, 0.3);
            touch-action: none;
        }

        .question-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #2c3e50 0%, #e74c3c 100%);
            padding: 45px;
            border-radius: 25px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.8);
            z-index: 1000;
            max-width: 750px;
            width: 92%;
            border: 4px solid #3498db;
            max-height: 90vh;
            overflow-y: auto;
        }

        .question-modal h3 {
            color: #3498db;
            font-size: 2em;
            margin-bottom: 25px;
            text-align: center;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }

        .question-modal p {
            color: white;
            font-size: 1.4em;
            margin-bottom: 30px;
            text-align: center;
            font-weight: bold;
            line-height: 1.6;
        }

        .question-modal.active { display: block; animation: popIn 0.4s ease-out; }

        .loss-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            padding: 60px;
            border-radius: 25px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.9);
            z-index: 1001;
            max-width: 600px;
            width: 90%;
            border: 5px solid white;
            text-align: center;
        }

        .loss-modal.active { display: block; animation: shake 0.6s; }

        .loss-modal h2 {
            color: white;
            font-size: 3em;
            margin-bottom: 30px;
            border: none;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
        }

        .loss-modal p {
            color: white;
            font-size: 1.5em;
            margin: 20px 0;
            line-height: 1.8;
        }

        .loss-modal button {
            background: white;
            color: #e74c3c;
            margin-top: 30px;
            font-size: 1.4em;
            padding: 20px 50px;
        }

        .loss-modal button:hover {
            background: #ecf0f1;
            color: #c0392b;
        }

        @keyframes popIn {
            from { transform: translate(-50%, -50%) scale(0.7); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 999;
        }

        .overlay.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .answer-option {
            display: block;
            width: 100%;
            padding: 20px;
            margin: 15px 0;
            background: white;
            border: 3px solid #3498db;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 1.15em;
            font-weight: 600;
            color: #2c3e50;
        }

        .answer-option:hover {
            background: linear-gradient(135deg, #fff9e6 0%, #ffe6e6 100%);
            border-color: #e74c3c;
            transform: translateX(15px) scale(1.03);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        .flashcard {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border-radius: 30px;
            padding: 50px;
            margin: 35px 0;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            transition: all 0.6s ease;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transform-style: preserve-3d;
            perspective: 2000px;
            border: 5px solid rgba(255, 255, 255, 0.5);
            overflow: hidden;
        }

        .flashcard::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(60deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: rotate(45deg);
            transition: all 0.7s;
        }

        .flashcard:hover::after { left: 100%; }

        .flashcard:nth-child(1) { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .flashcard:nth-child(2) { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .flashcard:nth-child(3) { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); }
        .flashcard:nth-child(4) { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }
        .flashcard:nth-child(5) { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .flashcard:nth-child(6) { background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); }

        .flashcard:hover {
            transform: translateY(-20px) scale(1.05) rotateX(8deg);
            box-shadow: 0 35px 80px rgba(0, 0, 0, 0.6);
        }

        .flashcard.flipped { animation: flipCard 0.8s ease-in-out; }

        @keyframes flipCard {
            0% { transform: rotateY(0deg) scale(1); }
            50% { transform: rotateY(180deg) scale(1.15); }
            100% { transform: rotateY(360deg) scale(1); }
        }

        .flashcard.flipped .flashcard-front { display: none; }
        .flashcard.flipped .flashcard-back { display: block; animation: fadeIn 0.5s ease-in; }

        .flashcard-front, .flashcard-back {
            text-align: center;
            color: white;
            position: relative;
            z-index: 10;
        }

        .flashcard-front h3 {
            color: white;
            font-size: 2.2em;
            text-shadow: 3px 3px 8px rgba(0, 0, 0, 0.5);
            margin: 0;
            font-weight: bold;
            line-height: 1.5;
        }

        .flashcard-back { display: none; }

        .flashcard-back p {
            color: white;
            font-size: 1.4em;
            line-height: 2.1;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
            font-weight: 500;
        }

        .flashcard::before {
            content: '⚡';
            position: absolute;
            top: 25px;
            right: 30px;
            font-size: 3em;
            opacity: 0.9;
            animation: pulseBulb 2s infinite;
            z-index: 5;
        }

        @keyframes pulseBulb {
            0%, 100% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.3); opacity: 1; }
        }

        .flashcard.flipped::before {
            content: '✅';
            color: #fff;
            font-size: 3.5em;
            animation: checkmark 0.6s ease-out;
        }

        @keyframes checkmark {
            0% { transform: scale(0) rotate(-45deg); }
            50% { transform: scale(1.3) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .example-box {
            background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%);
            border-left: 6px solid #e74c3c;
            padding: 25px;
            margin: 25px 0;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .formula-box {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 30px;
            margin: 25px 0;
            border-radius: 20px;
            font-size: 1.4em;
            text-align: center;
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4); }
            50% { box-shadow: 0 12px 35px rgba(52, 152, 219, 0.6); }
        }

        .formula-box strong {
            font-size: 1.8em;
            display: block;
            margin: 20px 0;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
        }

        .feedback-item {
            background: white;
            padding: 25px;
            margin: 18px 0;
            border-radius: 15px;
            border-left: 6px solid #95a5a6;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .feedback-item.correct {
            border-left-color: #27ae60;
            background: linear-gradient(135deg, #d5f4e6 0%, #a8e6cf 100%);
        }

        .feedback-item.incorrect {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #fadbd8 0%, #ffcccc 100%);
        }

        .student-info-box {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin: 25px 0;
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.4);
        }

        .student-info-box input {
            width: 100%;
            padding: 15px;
            margin: 12px 0;
            border: none;
            border-radius: 12px;
            font-size: 1.15em;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .block-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .block-overlay.active { display: flex; animation: fadeIn 0.5s; }

        .block-message {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            padding: 60px;
            border-radius: 25px;
            text-align: center;
            max-width: 650px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.8);
            border: 5px solid white;
            animation: shake 0.5s;
        }

        .block-message h2 {
            color: white;
            font-size: 3em;
            margin-bottom: 25px;
            border: none;
        }

        .block-message p {
            color: white;
            font-size: 1.4em;
            line-height: 2;
        }

        .warning-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            padding: 45px;
            border-radius: 25px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.7);
            z-index: 10000;
            border: 4px solid white;
            animation: shake 0.6s;
            max-width: 600px;
        }

        .warning-popup.active { display: block; }

        @keyframes shake {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-50%, -50%) rotate(-8deg); }
            75% { transform: translate(-50%, -50%) rotate(8deg); }
        }

        .warning-popup h3 {
            color: white;
            font-size: 2.2em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }

        .warning-popup p {
            color: white;
            font-size: 1.4em;
            margin: 12px 0;
            line-height: 1.8;
        }

        .start-button {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%) !important;
            font-size: 1.5em !important;
            padding: 25px 60px !important;
            margin: 30px auto !important;
            display: block !important;
            animation: pulseGreen 2s infinite !important;
        }

        @keyframes pulseGreen {
            0%, 100% { transform: scale(1); box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 10px 30px rgba(39, 174, 96, 0.6); }
        }

        .game-over-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            padding: 60px;
            border-radius: 25px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.9);
            z-index: 1002;
            max-width: 700px;
            width: 90%;
            border: 5px solid white;
            text-align: center;
        }

        .game-over-modal.active { display: block; animation: popIn 0.6s; }

        .game-over-modal h2 {
            color: white;
            font-size: 3.5em;
            margin-bottom: 30px;
            border: none;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
        }

        .game-over-modal p {
            color: white;
            font-size: 1.5em;
            margin: 20px 0;
            line-height: 1.8;
        }

        .game-over-modal button {
            background: white;
            color: #9b59b6;
            margin-top: 30px;
            font-size: 1.4em;
            padding: 20px 50px;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2.2em; }
            h2 { font-size: 1.8em; }
            .intro-slide h1 { font-size: 2.8em; }
            #gameCanvas { 
                height: 450px; 
                max-width: 100%;
            }
            .question-modal, .block-message, .warning-popup { width: 95%; padding: 25px; }
            .slide-content { padding: 20px; }
            button { padding: 15px 30px; font-size: 1.1em; }
            .nav-buttons { flex-direction: column; gap: 15px; }
            .nav-buttons button { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>
    <div class="block-overlay" id="blockOverlay">
        <div class="block-message">
            <h2>🚫 EVALUACIÓN BLOQUEADA</h2>
            <p>Has salido de la página <span id="finalExitCount">3</span> veces.</p>
            <p>Por razones de seguridad y para garantizar la integridad de la evaluación, el acceso ha sido bloqueado permanentemente.</p>
            <p style="margin-top: 25px; font-weight: bold;">⚠️ Tu evaluación NO será válida.</p>
        </div>
    </div>

    <div class="warning-popup" id="warningPopup">
        <h3>⚠️ ADVERTENCIA</h3>
        <p id="warningText">Has salido de la página.</p>
        <p id="remainingExits" style="font-weight: bold;"></p>
        <p style="margin-top: 20px; font-size: 1.2em;">🚨 Si continúas saliendo, tu evaluación será BLOQUEADA.</p>
    </div>
    
    <div class="loss-modal" id="lossModal">
        <h2>💥 ¡PERDISTE!</h2>
        <p style="font-size: 1.8em;" id="lossReason">Has chocado con un obstáculo</p>
        <p style="font-size: 1.4em; margin-top: 25px;">A continuación deberás contestar una pregunta de evaluación</p>
        <button onclick="showQuestionAfterLoss()">✅ ACEPTAR</button>
    </div>
    
    <div class="game-over-modal" id="gameOverModal">
        <h2>🎮 GAME OVER</h2>
        <p style="font-size: 1.8em;">¡Completaste las 20 preguntas!</p>
        <p style="font-size: 1.6em; color: #f1c40f;">Puntuación: <span id="gameOverScore">0</span>/20</p>
        <p style="font-size: 1.4em; margin-top: 25px;">Presiona el botón para ver tus resultados</p>
        <button onclick="showFinalResults()">📊 VER RESULTADOS</button>
    </div>
    
    <div class="question-modal" id="questionModal">
        <h3>⚠️ Pregunta de Evaluación</h3>
        <p id="questionText"></p>
        <div id="optionsContainer"></div>
    </div>

    <div class="container">
        <!-- Slide 1: Intro -->
        <div class="slide active intro-slide">
            <div class="slide-content">
                <div class="force-icon">⚡</div>
                <h1>Leyes de Newton</h1>
                <h2 style="color: #2c3e50;">Fuerza y Movimiento</h2>
                <p style="font-size: 1.4em; color: #7f8c8d; margin: 35px 0;">
                    Descubre cómo las fuerzas producen movimiento y cambian la velocidad de los objetos
                </p>
                <div class="nav-buttons">
                    <button onclick="nextSlide()" style="margin: 0 auto; font-size: 1.4em; padding: 22px 60px;">
                        🚀 Comenzar
                    </button>
                </div>
            </div>
        </div>

        <!-- Slide 2: Información del Estudiante -->
        <div class="slide">
            <div class="slide-content">
                <h2>📝 Información del Estudiante</h2>
                <div class="student-info-box">
                    <h3 style="color: white; text-align: center; margin-bottom: 25px; font-size: 1.8em;">
                        Por favor, ingresa tus datos antes de comenzar
                    </h3>
                    <input type="text" id="studentName" placeholder="Tu nombre completo" required>
                    <input type="text" id="studentCourse" placeholder="Tu curso (ej: 10-1)" required>
                    <input type="text" id="studentSchool" placeholder="Tu colegio" required>
                </div>
                <p style="text-align: center; color: #7f8c8d; margin: 25px 0; font-size: 1.2em;">
                    ⚠️ Esta información será incluida en tus resultados finales
                </p>
                <div class="nav-buttons">
                    <button onclick="prevSlide()">← Anterior</button>
                    <button onclick="saveStudentInfo()">Continuar →</button>
                </div>
            </div>
        </div>

        <!-- Slide 3: Primera Ley -->
        <div class="slide">
            <div class="slide-content">
                <h2>🎯 Primera Ley de Newton: Ley de la Inercia</h2>
                
                <p style="font-size: 1.3em; font-weight: bold; color: #e74c3c; background: #fff3cd; padding: 20px; border-radius: 15px; border-left: 6px solid #e74c3c;">
                    "Un objeto en reposo permanece en reposo, y un objeto en movimiento continúa moviéndose en línea recta a velocidad constante, a menos que una fuerza externa actúe sobre él"
                </p>

                <h3>¿Qué significa esto?</h3>
                <p>
                    Imagínate que estás en un autobús y de repente frena. ¿Qué pasa? Te vas hacia adelante, ¿cierto? 
                    Eso es la inercia: tu cuerpo quiere seguir moviéndose aunque el bus se detenga.
                </p>

                <div class="example-box">
                    <h4 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.3em;">🚗 Ejemplo cotidiano:</h4>
                    <p style="font-size: 1.1em;">
                        <strong>Situación:</strong> Cuando viajas en carro y el conductor frena bruscamente, tu cuerpo se va hacia adelante.
                    </p>
                    <p style="font-size: 1.1em;">
                        <strong>Explicación:</strong> Tu cuerpo estaba en movimiento (igual que el carro). Cuando el carro frena, 
                        el carro se detiene por la fuerza de los frenos, pero tu cuerpo quiere seguir moviéndose por la inercia. 
                        Por eso necesitamos el cinturón de seguridad.
                    </p>
                </div>

                <h3>📌 Conceptos clave:</h3>
                <p>
                    <strong>• Inercia:</strong> Es la resistencia que tiene un objeto a cambiar su estado de movimiento. 
                    Entre más masa tenga un objeto, más inercia tiene.
                </p>
                <p>
                    <strong>• Fuerza externa:</strong> Es cualquier empuje o jalón que viene de afuera del objeto. 
                    Sin fuerza externa, el objeto no cambia su movimiento.
                </p>

                <div class="nav-buttons">
                    <button onclick="prevSlide()">← Anterior</button>
                    <button onclick="nextSlide()">Siguiente →</button>
                </div>
            </div>
        </div>

        <!-- Slide 4: Segunda Ley -->
        <div class="slide">
            <div class="slide-content">
                <h2>⚡ Segunda Ley de Newton: Fuerza, Masa y Aceleración</h2>
                
                <div class="formula-box">
                    <p style="font-size: 1.1em;">La fórmula más importante de esta ley es:</p>
                    <strong>F = m × a</strong>
                    <p style="margin-top: 20px; font-size: 0.95em;">
                        Fuerza = masa × aceleración
                    </p>
                </div>

                <h3>🔍 ¿Qué significa cada letra?</h3>
                <p style="font-size: 1.1em;">
                    <strong>• F (Fuerza):</strong> Se mide en Newtons (N). Es el empuje o jalón que aplicamos al objeto. 
                    1 Newton es aproximadamente la fuerza que haces para levantar una manzana.
                </p>
                <p style="font-size: 1.1em;">
                    <strong>• m (masa):</strong> Se mide en kilogramos (kg). Es la cantidad de materia que tiene el objeto. 
                    NO confundir con peso.
                </p>
                <p style="font-size: 1.1em;">
                    <strong>• a (aceleración):</strong> Se mide en metros por segundo cuadrado (m/s²). Es qué tan rápido cambia 
                    la velocidad del objeto.
                </p>

                <div class="example-box">
                    <h4 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.3em;">🎯 Ejemplo sencillo:</h4>
                    <p style="font-size: 1.1em;">
                        <strong>Problema:</strong> Si empujas una caja de 5 kg con una fuerza de 20 N, ¿qué aceleración tiene?
                    </p>
                    <p style="font-size: 1.05em;">
                        <strong>Datos:</strong><br>
                        • Masa (m) = 5 kg<br>
                        • Fuerza (F) = 20 N<br>
                        • Aceleración (a) = ?
                    </p>
                    <p style="font-size: 1.05em;">
                        <strong>Solución:</strong><br>
                        Usamos F = m × a, pero necesitamos "a", entonces despejamos:<br>
                        a = F / m<br>
                        a = 20 N / 5 kg<br>
                        a = 4 m/s²
                    </p>
                    <p style="font-size: 1.1em; background: #d5f4e6; padding: 15px; border-radius: 10px; margin-top: 10px;">
                        <strong>Respuesta:</strong> La caja acelera a 4 m/s². Esto significa que cada segundo, 
                        su velocidad aumenta 4 metros por segundo.
                    </p>
                </div>

                <h3>💡 Regla de oro:</h3>
                <p style="background: #fff3cd; padding: 20px; border-radius: 15px; border-left: 5px solid #f39c12; font-size: 1.1em;">
                    ⚠️ Si la fuerza aumenta → la aceleración aumenta<br>
                    ⚠️ Si la masa aumenta → la aceleración disminuye<br>
                    ⚠️ Es más fácil acelerar un objeto liviano que uno pesado
                </p>

                <div class="nav-buttons">
                    <button onclick="prevSlide()">← Anterior</button>
                    <button onclick="nextSlide()">Siguiente →</button>
                </div>
            </div>
        </div>

        <!-- Slide 5: Ejercicio Resuelto -->
        <div class="slide">
            <div class="slide-content">
                <h2>📝 Ejercicio Resuelto Paso a Paso</h2>
                
                <div class="example-box">
                    <h4 style="color: #2c3e50; margin-bottom: 20px; font-size: 1.4em;">
                        📌 Problema: Un cuerpo de 8 kg recibe una fuerza de 24 N. ¿Qué aceleración experimenta?
                    </h4>
                    
                    <h3 style="color: #e74c3c; font-size: 1.3em;">PASO 1: Identificar los datos</h3>
                    <p style="font-size: 1.1em;">
                        • Masa (m) = 8 kg<br>
                        • Fuerza (F) = 24 N<br>
                        • Aceleración (a) = ? (esto es lo que buscamos)
                    </p>

                    <h3 style="color: #e74c3c; font-size: 1.3em;">PASO 2: Escribir la fórmula</h3>
                    <p style="font-size: 1.1em;">
                        Sabemos que: <strong>F = m × a</strong>
                    </p>

                    <h3 style="color: #e74c3c; font-size: 1.3em;">PASO 3: Despejar lo que buscamos</h3>
                    <p style="font-size: 1.1em;">
                        Como buscamos "a", despejamos dividiendo ambos lados entre "m":<br>
                        <strong>a = F / m</strong>
                    </p>

                    <h3 style="color: #e74c3c; font-size: 1.3em;">PASO 4: Sustituir los valores</h3>
                    <p style="font-size: 1.1em;">
                        a = 24 N / 8 kg<br>
                        a = 3 m/s²
                    </p>

                    <h3 style="color: #e74c3c; font-size: 1.3em;">PASO 5: Respuesta final</h3>
                    <p style="background: #d4edda; padding: 20px; border-radius: 15px; font-weight: bold; font-size: 1.2em;">
                        ✅ La aceleración del cuerpo es 3 m/s²
                    </p>
                </div>

                <div class="example-box">
                    <h4 style="color: #2c3e50; margin-bottom: 20px; font-size: 1.4em;">
                        📌 Otro ejemplo: ¿Qué fuerza se necesita para acelerar un objeto de 12 kg a 2 m/s²?
                    </h4>
                    
                    <p style="font-size: 1.1em;">
                        <strong>Datos:</strong><br>
                        • Masa (m) = 12 kg<br>
                        • Aceleración (a) = 2 m/s²<br>
                        • Fuerza (F) = ?
                    </p>

                    <p style="font-size: 1.1em;">
                        <strong>Fórmula:</strong> F = m × a
                    </p>

                    <p style="font-size: 1.1em;">
                        <strong>Sustitución:</strong><br>
                        F = 12 kg × 2 m/s²<br>
                        F = 24 N
                    </p>

                    <p style="background: #d4edda; padding: 20px; border-radius: 15px; font-weight: bold; font-size: 1.2em;">
                        ✅ Se necesita una fuerza de 24 N
                    </p>
                </div>

                <div class="nav-buttons">
                    <button onclick="prevSlide()">← Anterior</button>
                    <button onclick="nextSlide()">Siguiente →</button>
                </div>
            </div>
        </div>

        <!-- Slide 6: Varias Fuerzas -->
        <div class="slide">
            <div class="slide-content">
                <h2>🔄 Cuando actúan varias fuerzas</h2>
                
                <p style="font-size: 1.3em; font-weight: bold; color: #e74c3c; background: #fff3cd; padding: 20px; border-radius: 15px; border-left: 6px solid #e74c3c;">
                    A veces sobre un objeto actúan varias fuerzas al mismo tiempo. Debemos encontrar la FUERZA RESULTANTE.
                </p>

                <h3>📐 Dos casos importantes:</h3>

                <div class="example-box">
                    <h4 style="color: #2c3e50; font-size: 1.3em;">CASO 1: Fuerzas en la misma dirección</h4>
                    <p style="font-size: 1.1em;">
                        Si dos personas empujan una caja en la misma dirección:<br>
                        • Persona 1 empuja con 30 N →<br>
                        • Persona 2 empuja con 20 N →<br>
                        <strong style="font-size: 1.15em;">Fuerza resultante = 30 N + 20 N = 50 N →</strong>
                    </p>
                    <p style="background: #d1ecf1; padding: 15px; border-radius: 10px; font-size: 1.1em;">
                        💡 <strong>Regla:</strong> Se SUMAN las fuerzas
                    </p>
                </div>

                <div class="example-box">
                    <h4 style="color: #2c3e50; font-size: 1.3em;">CASO 2: Fuerzas en direcciones opuestas</h4>
                    <p style="font-size: 1.1em;">
                        Si una persona empuja y otra jala en sentido contrario:<br>
                        • Persona 1 empuja con 50 N →<br>
                        • Persona 2 jala con 20 N ←<br>
                        <strong style="font-size: 1.15em;">Fuerza resultante = 50 N - 20 N = 30 N →</strong>
                    </p>
                    <p style="background: #d1ecf1; padding: 15px; border-radius: 10px; font-size: 1.1em;">
                        💡 <strong>Regla:</strong> Se RESTAN las fuerzas
                    </p>
                </div>

                <div class="nav-buttons">
                    <button onclick="prevSlide()">← Anterior</button>
                    <button onclick="nextSlide()">Siguiente →</button>
                </div>
            </div>
        </div>

        <!-- Slide 7: Ejercicios Avanzados -->
        <div class="slide">
            <div class="slide-content">
                <h2>🎓 Ejercicios Avanzados</h2>
                
                <div class="example-box" style="border-left-color: #9b59b6;">
                    <h4 style="color: #9b59b6; margin-bottom: 20px; font-size: 1.5em;">
                        📌 EJERCICIO 1: Fuerzas Perpendiculares (90 grados)
                    </h4>
                    
                    <p style="font-size: 1.2em; background: #fff3cd; padding: 15px; border-radius: 10px; font-weight: bold;">
                        Sobre un cuerpo de 8 kg actúan dos fuerzas perpendiculares entre sí: una de 12 N hacia el este 
                        y otra de 5 N hacia el norte. Calcular la aceleración del sistema y la tensión del hilo.
                    </p>

                    <h3 style="color: #9b59b6; font-size: 1.3em; margin-top: 25px;">PASO 1: Entender el problema</h3>
                    <p style="font-size: 1.1em;">
                        Cuando dos fuerzas son perpendiculares (forman 90°), NO se suman ni se restan directamente. 
                        Debemos usar el <strong>Teorema de Pitágoras</strong> para encontrar la fuerza resultante.
                    </p>

                    <h3 style="color: #9b59b6; font-size: 1.3em;">PASO 2: Datos</h3>
                    <p style="font-size: 1.1em;">
                        • F₁ = 12 N (hacia el este) →<br>
                        • F₂ = 5 N (hacia el norte) ↑<br>
                        • m = 8 kg<br>
                        • Ángulo entre las fuerzas = 90°
                    </p>

                    <h3 style="color: #9b59b6; font-size: 1.3em;">PASO 3: Calcular la fuerza resultante</h3>
                    <div class="formula-box" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); text-align: left; padding: 20px;">
                        <p style="font-size: 1.05em;">Cuando las fuerzas forman 90°, usamos:</p>
                        <strong style="font-size: 1.5em;">F_R = √(F₁² + F₂²)</strong>
                        <p style="margin-top: 15px; font-size: 0.95em;">Esto es el Teorema de Pitágoras aplicado a fuerzas</p>
                    </div>

                    <p style="font-size: 1.1em;">
                        <strong>Sustituyendo:</strong><br>
                        F_R = √(12² + 5²)<br>
                        F_R = √(144 + 25)<br>
                        F_R = √169<br>
                        F_R = 13 N
                    </p>

                    <h3 style="color: #9b59b6; font-size: 1.3em;">PASO 4: Calcular la aceleración</h3>
                    <p style="font-size: 1.1em;">
                        Ahora que tenemos F_R, usamos F = m × a:<br>
                        13 N = 8 kg × a<br>
                        a = 13 N / 8 kg<br>
                        a = 1.625 m/s²
                    </p>

                    <p style="background: #d4edda; padding: 20px; border-radius: 15px; font-weight: bold; font-size: 1.2em; margin-top: 20px;">
                        ✅ Fuerza resultante = 13 N<br>
                        ✅ Aceleración del sistema = 1.625 m/s²
                    </p>

                    <div style="background: #e8daef; padding: 20px; border-radius: 15px; margin-top: 20px; border-left: 5px solid #9b59b6;">
                        <p style="font-size: 1.15em; color: #5b2c6f;">
                            <strong>💡 Concepto clave:</strong> Cuando dos fuerzas son perpendiculares, la fuerza resultante 
                            SIEMPRE será mayor que cualquiera de las dos fuerzas individuales, pero menor que su suma. 
                            En este caso: 12 N < 13 N < 17 N (12+5)
                        </p>
                    </div>
                </div>

                <div class="example-box" style="border-left-color: #e67e22; margin-top: 35px;">
                    <h4 style="color: #e67e22; margin-bottom: 20px; font-size: 1.5em;">
                        📌 EJERCICIO 2: Combinando Newton con Movimiento Rectilíneo Uniformemente Acelerado (MRUA)
                    </h4>
                    
                    <p style="font-size: 1.2em; background: #fff3cd; padding: 15px; border-radius: 10px; font-weight: bold;">
                        Un cuerpo de 4 kg, inicialmente en reposo, recibe una fuerza constante de 32 N. 
                        ¿Qué velocidad tendrá el cuerpo después de recorrer 14 metros?
                    </p>

                    <h3 style="color: #e67e22; font-size: 1.3em; margin-top: 25px;">PASO 1: Entender el problema</h3>
                    <p style="font-size: 1.1em;">
                        Este ejercicio combina las <strong>Leyes de Newton</strong> con las <strong>ecuaciones de MRUA</strong>. 
                        Primero usamos F = m × a para encontrar la aceleración, y luego usamos una ecuación de movimiento 
                        para encontrar la velocidad final.
                    </p>

                    <h3 style="color: #e67e22; font-size: 1.3em;">PASO 2: Datos</h3>
                    <p style="font-size: 1.1em;">
                        • m = 4 kg<br>
                        • F = 32 N<br>
                        • v₀ = 0 m/s (parte del reposo)<br>
                        • d = 14 m (distancia recorrida)<br>
                        • v_f = ? (velocidad final)
                    </p>

                    <h3 style="color: #e67e22; font-size: 1.3em;">PASO 3: Calcular la aceleración (Segunda Ley de Newton)</h3>
                    <p style="font-size: 1.1em;">
                        F = m × a<br>
                        32 N = 4 kg × a<br>
                        a = 32 N / 4 kg<br>
                        <strong>a = 8 m/s²</strong>
                    </p>

                    <h3 style="color: #e67e22; font-size: 1.3em;">PASO 4: Calcular la velocidad final (Ecuación de MRUA)</h3>
                    <div class="formula-box" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); text-align: left; padding: 20px;">
                        <p style="font-size: 1.05em;">Usamos la ecuación de MRUA que relaciona velocidad, aceleración y distancia:</p>
                        <strong style="font-size: 1.5em;">v_f² = v_0² + 2ad</strong>
                        <p style="margin-top: 15px; font-size: 0.95em;">
                            Donde:<br>
                            • v_f = velocidad final<br>
                            • v_0 = velocidad inicial<br>
                            • a = aceleración<br>
                            • d = distancia
                        </p>
                    </div>

                    <p style="font-size: 1.1em;">
                        <strong>Sustituyendo los valores:</strong><br>
                        v_f² = 0² + 2(8 m/s²)(14 m)<br>
                        v_f² = 0 + 224<br>
                        v_f² = 224<br>
                        v_f = √224<br>
                        v_f ≈ 14.97 m/s
                    </p>

                    <p style="background: #d4edda; padding: 20px; border-radius: 15px; font-weight: bold; font-size: 1.2em; margin-top: 20px;">
                        ✅ Aceleración = 8 m/s²<br>
                        ✅ Velocidad final = 14.97 m/s (aproximadamente 15 m/s)<br>
                        ✅ Esto equivale a 54 km/h
                    </p>

                    <div style="background: #fdebd0; padding: 20px; border-radius: 15px; margin-top: 20px; border-left: 5px solid #e67e22;">
                        <p style="font-size: 1.15em; color: #7d4e26;">
                            <strong>💡 Concepto clave:</strong> Este ejercicio muestra cómo las Leyes de Newton 
                            y las ecuaciones de movimiento trabajan juntas. La Segunda Ley nos da la aceleración, 
                            y las ecuaciones de MRUA nos permiten predecir cómo se moverá el objeto en el tiempo.
                        </p>
                        <p style="font-size: 1.1em; color: #7d4e26; margin-top: 15px;">
                            <strong>Otras ecuaciones útiles de MRUA:</strong><br>
                            • v_f = v_0 + at (velocidad en función del tiempo)<br>
                            • d = v_0t + ½at² (distancia en función del tiempo)<br>
                            • v_f² = v_0² + 2ad (la que usamos aquí)
                        </p>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button onclick="prevSlide()">← Anterior</button>
                    <button onclick="nextSlide()">Siguiente →</button>
                </div>
            </div>
        </div>

        <!-- Slide 8: Tarjetas Didácticas -->
        <div class="slide">
            <div class="slide-content">
                <h2>🎴 Tarjetas Didácticas</h2>
                <p style="font-size: 1.3em; text-align: center; color: #7f8c8d; margin-bottom: 35px;">
                    Haz clic en cada tarjeta para ver la respuesta
                </p>

                <div class="flashcard" onclick="flipCard(this)">
                    <div class="flashcard-front">
                        <h3>¿Qué dice la Primera Ley de Newton?</h3>
                    </div>
                    <div class="flashcard-back">
                        <p>
                            Un objeto en reposo permanece en reposo, y un objeto en movimiento continúa en movimiento 
                            con velocidad constante, a menos que una fuerza externa actúe sobre él. Esta es la ley de la inercia.
                        </p>
                    </div>
                </div>

                <div class="flashcard" onclick="flipCard(this)">
                    <div class="flashcard-front">
                        <h3>¿Qué es la inercia?</h3>
                    </div>
                    <div class="flashcard-back">
                        <p>
                            La inercia es la resistencia que tiene un objeto a cambiar su estado de movimiento. 
                            Entre más masa tenga un objeto, más inercia tiene. Por ejemplo, es más difícil empujar 
                            un carro que una bicicleta porque el carro tiene más inercia.
                        </p>
                    </div>
                </div>

                <div class="flashcard" onclick="flipCard(this)">
                    <div class="flashcard-front">
                        <h3>¿Cuál es la fórmula de la Segunda Ley de Newton?</h3>
                    </div>
                    <div class="flashcard-back">
                        <p>
                            La fórmula es <strong>F = m × a</strong>, donde:<br>
                            • F = Fuerza (en Newtons, N)<br>
                            • m = masa (en kilogramos, kg)<br>
                            • a = aceleración (en m/s²)
                        </p>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button onclick="prevSlide()">← Anterior</button>
                    <button onclick="nextSlide()">Siguiente →</button>
                </div>
            </div>
        </div>

        <!-- Slide 9: Introducción al Juego -->
        <div class="slide">
            <div class="slide-content">
                <h2>🎮 ¡Hora del Juego y Evaluación!</h2>
                
                <div style="text-align: center; margin: 35px 0;">
                    <div class="force-icon">🎯</div>
                    <h3 style="color: #e74c3c; font-size: 2.5em;">Desafío Integrado (20 Preguntas)</h3>
                </div>

                <div class="example-box" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; border: none;">
                    <h3 style="color: white; font-size: 1.8em;">📋 Reglas de la Evaluación:</h3>
                    <p style="font-size: 1.3em; color: white;">
                        🎮 <strong>Objetivo Principal:</strong> ¡Sobrevive esquivando obstáculos y manteniendo tu energía!
                    </p>
                    <p style="font-size: 1.3em; color: white;">
                        🕹️ <strong>Cómo jugar:</strong><br>
                        • Mueve tu nave con las FLECHAS ← → o BOTONES DENTRO del juego<br>
                        • Esquiva los obstáculos rojos que caen<br>
                        • El juego comienza cuando te mueves por primera vez
                    </p>
                    <p style="font-size: 1.3em; color: white; background: #f39c12; padding: 10px; border-radius: 10px;">
                        ⚡ <strong>SISTEMA DE ENERGÍA:</strong><br>
                        • Tu energía baja CONSTANTEMENTE<br>
                        • Debes RECOGER ESTRELLAS VERDES para recuperar energía (+20%)<br>
                        • Si tu energía llega a 0% = PIERDES
                    </p>
                    <p style="font-size: 1.3em; color: white;">
                        ❓ <strong>Sistema de Preguntas:</strong><br>
                        • Cuando chocas o tu energía llega a 0, aparece una pregunta<br>
                        • Respondes correctamente: Sigues jugando<br>
                        • 20 preguntas en total = Fin del juego
                    </p>
                    <p style="font-size: 1.3em; color: white; background: #27ae60; padding: 10px; border-radius: 10px;">
                        🏆 <strong>CONDICIÓN DE EXONERACIÓN:</strong><br>
                        • Si sobrevives **10 minutos** sin perder, serás **EXONERADO**<br>
                        • Recibirás automáticamente **20/20** puntos
                    </p>
                </div>

                <p style="text-align: center; font-size: 1.5em; color: #e74c3c; font-weight: bold; margin: 35px 0; background: #fff3cd; padding: 25px; border-radius: 15px;">
                    🎯 Total de preguntas disponibles: 20
                </p>

                <div class="nav-buttons">
                    <button onclick="prevSlide()">← Anterior</button>
                    <button onclick="startGame()" style="font-size: 1.3em; padding: 22px 50px; background: linear-gradient(135deg, #27ae60 0%, #229954 100%);">
                        🚀 ¡Empezar Desafío!
                    </button>
                </div>
            </div>
        </div>

        <!-- Slide 10: Juego -->
        <div class="slide">
            <div class="slide-content">
                <h2 id="gameTitle">🎮 Evaluación en Curso</h2>
                
                <div style="position: relative;">
                    <canvas id="gameCanvas" width="900" height="500"></canvas>
                </div>

                <div style="text-align: center; margin-top: 25px;">
                    <p id="gameMessage" style="font-size: 1.2em; color: #7f8c8d;">
                        🎮 Usa las FLECHAS ← → o los BOTONES dentro del juego
                    </p>
                    <button id="startRoundButton" class="start-button" style="display: none;" onclick="startNewRound()">
                        🚀 COMENZAR RONDA
                    </button>
                </div>

                <div id="gameFeedback" style="margin-top: 35px;"></div>
            </div>
        </div>

        <!-- Slide 11: Resultados -->
        <div class="slide">
            <div class="slide-content">
                <h2>🎉 Resultados Finales</h2>
                
                <div class="student-info-box">
                    <h3 style="color: white; text-align: center; font-size: 1.8em;">Datos del Estudiante</h3>
                    <p id="studentNameDisplay" style="font-size: 1.3em; margin: 12px 0;"></p>
                    <p id="studentCourseDisplay" style="font-size: 1.3em; margin: 12px 0;"></p>
                    <p id="studentSchoolDisplay" style="font-size: 1.3em; margin: 12px 0;"></p>
                    <p id="exitCountDisplay" style="font-size: 1.3em; margin: 12px 0; color: #fff; font-weight: bold;"></p>
                </div>

                <h3 style="margin-top: 35px; font-size: 2em;">📊 Puntuaciones Detalladas:</h3>

                <div class="example-box">
                    <h4 style="color: #2c3e50; font-size: 1.4em;">🎮 Desafío del Juego:</h4>
                    <p style="font-size: 1.3em;">
                        Preguntas respondidas: <span id="finalGameQuestions" style="font-weight: bold; color: #e74c3c;">0/20</span>
                    </p>
                    <p style="font-size: 1.2em;">
                        Respuestas correctas: <span id="finalCorrectCount" style="font-weight: bold;">0</span>
                    </p>
                    <p style="font-size: 1.3em; color: #27ae60; font-weight: bold;" id="exonerationStatus"></p>
                </div>

                <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 35px; border-radius: 20px; margin: 35px 0; text-align: center; box-shadow: 0 15px 40px rgba(231, 76, 60, 0.5);">
                    <h3 style="color: white; font-size: 2.5em; border: none;">📊 Puntuación Total:</h3>
                    <p style="font-size: 3em; font-weight: bold; margin: 25px 0;" id="totalScore">0/20 (0%)</p>
                    <p style="font-size: 1.5em;" id="finalMessage"></p>
                </div>

                <div id="quizFeedback" style="margin: 35px 0;"></div>

                <div class="nav-buttons" style="justify-content: center;">
                    <button onclick="sendResultsByEmail()" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); font-size: 1.3em; padding: 22px 50px;">
                        📧 Enviar Resultados por Correo
                    </button>
                </div>

                <p style="text-align: center; color: #7f8c8d; margin-top: 25px; font-size: 1.05em;">
                    ⚠️ Recuerda tomar captura de pantalla de tus resultados antes de enviar el correo
                </p>
            </div>
        </div>
    </div>

    <script>
        let currentSlide = 0;
        let gameActive = false;
        let isBlocked = false;
        let trackingStarted = false;
        let exitCount = 0;
        const maxExits = 3;
        const QUIZ_ACTIVE_KEY = 'quizActive'; 
        const GAME_FINISHED_KEY = 'gameFinished';
        const EXEMPTION_TIME_MS = 600000; // 10 minutos
        const TRAP_TRIGGER_MS = 540000; // 9 minutos
        let onResultsPage = false; // NUEVA VARIABLE PARA CONTROLAR SI ESTÁ EN RESULTADOS

        // Variables del juego
        let canvas, ctx;
        let gameStarted = false;
        let waitingForQuestion = false;
        let roundPaused = true;
        let waitingForMovement = false;
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        let player = { 
            x: 400, 
            y: 420, 
            width: isMobile ? 70 : 50,
            height: isMobile ? 70 : 50,
            speed: isMobile ? 10 : 8
        };
        let obstacles = [];
        let stars = [];
        let gameScore = 0;
        let starsCollected = 0;
        let playerEnergy = 100;
        let energyDecayRate = 0.15;
        let frameCount = 0;
        let gameQuestions = [];
        let currentQuestionIndex = 0;
        let gameAnswers = [];
        let difficultyLevel = 1;
        let obstacleSpeed = 3;
        let obstacleFrequency = 80;
        let obstacleWidth = isMobile ? 80 : 60;
        let gameStartTime = Date.now();
        let roundStartTime = Date.now();
        let totalGameTime = 0;
        let gameExonerated = false;
        let trapActivated = false;
        let keys = {};
        let touchStartX = 0;
        let lastStarCollectTime = Date.now();
        let gameCompleted = false;

        // NUEVAS VARIABLES PARA CONTROLES TÁCTILES DENTRO DEL CANVAS
        let leftPressed = false;
        let rightPressed = false;
        let leftButtonBounds = {};
        let rightButtonBounds = {};

        // Preguntas del cuestionario (20 preguntas)
        const quizQuestions = shuffleArray([
            {
                question: "Un patinador se desliza sin aplicar fuerza en una pista de hielo idealmente lisa. ¿Qué describe mejor su movimiento según la Primera Ley?",
                options: [
                    "Su velocidad se reduce por la fricción del aire.",
                    "Se detendrá una vez que la inercia se agote.",
                    "Mantendrá una velocidad constante, pues la fuerza neta es cero.", 
                    "Aumentará su aceleración por la ausencia de fricción."
                ],
                correct: 2 
            },
            {
                question: "¿Por qué un objeto con el doble de masa requiere el doble de fuerza para alcanzar la misma aceleración?",
                options: [
                    "Porque la fuerza neta aplicada aumenta la inercia directamente.",
                    "Porque la aceleración y la masa son inversamente proporcionales, no directamente.",
                    "Porque la Segunda Ley establece F = m * a, demostrando una relación directamente proporcional entre F y m.", 
                    "Porque la inercia solo se aplica a objetos en reposo."
                ],
                correct: 2
            },
            {
                question: "Una fuerza de 40 N actúa sobre un cuerpo de 5 kg. ¿Cuál es la aceleración producida?",
                options: ["8 m/s²", "0.125 m/s²", "200 N", "35 m/s"],
                correct: 0
            },
            {
                question: "Si la aceleración de un objeto es 0.5 m/s² y su masa es 18 kg, ¿cuál es la magnitud de la fuerza neta que actúa sobre él?",
                options: ["9 N", "36 N", "18.5 N", "0.027 N"],
                correct: 0
            },
            {
                question: "Sobre un cuerpo actúan dos fuerzas en la misma dirección: 15 N y 7 N. Si la masa es 4 kg, ¿cuál es la aceleración del cuerpo?",
                options: ["22 N", "5.5 m/s²", "2.75 m/s²", "8 m/s²"],
                correct: 1
            },
            {
                question: "Dos fuerzas, 50 N y 30 N, actúan en direcciones opuestas sobre un objeto de 16 kg. ¿Cuál es la aceleración neta?",
                options: ["5 m/s²", "1.25 m/s²", "3.125 m/s²", "80 m/s²"],
                correct: 1
            },
            {
                question: "La fuerza es una magnitud vectorial. ¿Qué implica esto para su representación y cálculo?",
                options: [
                    "Solo importa su magnitud (cantidad).",
                    "Solo se puede sumar si las direcciones son opuestas.",
                    "Requiere magnitud y dirección para ser totalmente especificada.", 
                    "Siempre es directamente proporcional a la velocidad."
                ],
                correct: 2
            },
            {
                question: "Un objeto tiene una aceleración de 10 m/s² bajo una fuerza neta F. Si la fuerza se duplica y la masa se reduce a la mitad, ¿cuál es la nueva aceleración?",
                options: ["20 m/s²", "5 m/s²", "10 m/s²", "40 m/s²"],
                correct: 3
            },
            {
                question: "¿Qué condición es necesaria para que un objeto en movimiento se mueva con velocidad constante?",
                options: [
                    "Que su masa sea cero (imposible).",
                    "Que la fuerza neta sobre el objeto sea exactamente cero.", 
                    "Que la fuerza neta sea constante y positiva.",
                    "Que el objeto se mueva en el vacío."
                ],
                correct: 1
            },
            {
                question: "Si una fuerza de 10 N actúa sobre dos objetos, uno de 2 kg y otro de 5 kg. ¿Cuál acelera más?",
                options: [
                    "El de 5 kg con 2 m/s².",
                    "El de 2 kg con 5 m/s².", 
                    "Ambos aceleran a 10 m/s².",
                    "El de 5 kg acelera con 0.5 m/s²."
                ],
                correct: 1
            },
            {
                question: "Si actúan dos fuerzas perpendiculares, 6 N y 8 N, sobre un cuerpo de 2 kg. ¿Cuál es la fuerza resultante (neta)?",
                options: ["14 N", "2 N", "10 N", "48 N"],
                correct: 2
            },
            {
                question: "Si la aceleración de un cuerpo de 10 kg cambia de 2 m/s² a 5 m/s², ¿cuánto aumentó la fuerza neta?",
                options: ["Aumentó 3 N", "Aumentó 30 N", "Aumentó 70 N", "Aumentó 10 N"],
                correct: 1
            },
            {
                question: "La inercia de un objeto es directamente proporcional a:",
                options: ["Su aceleración.", "Su velocidad.", "La fuerza neta aplicada.", "Su masa."],
                correct: 3
            },
            {
                question: "Un cuerpo de 10 kg, inicialmente en reposo, recibe una fuerza constante de 20 N. ¿Qué velocidad tendrá después de 4 s?",
                options: ["a = 2 m/s². v_f = 8 m/s.", "a = 0.5 m/s². v_f = 2 m/s.", "v_f = 20 m/s.", "v_f = 16 m/s."],
                correct: 0
            },
            {
                question: "Una fuerza de 15 N actúa sobre un cuerpo de 3 kg. ¿Qué distancia recorrerá el cuerpo desde el reposo en 2 s?",
                options: ["10 metros", "5 metros", "20 metros", "15 metros"],
                correct: 0
            },
            {
                question: "Un objeto de 4 kg parte del reposo y alcanza una velocidad de 16 m/s en 4 s. ¿Cuál fue la fuerza neta aplicada?",
                options: ["a = 1 m/s². F = 4 N.", "a = 4 m/s². F = 16 N.", "F = 8 N.", "F = 32 N."],
                correct: 1
            },
            {
                question: "Una fuerza de 60 N se aplica a un objeto de 5 kg. ¿Qué velocidad alcanza después de recorrer 10 m desde el reposo?",
                options: ["v_f ≈ 24 m/s.", "v_f ≈ 12 m/s.", "v_f ≈ 15.5 m/s.", "v_f ≈ 20 m/s."],
                correct: 2
            },
            {
                question: "Una caja de 2 kg tiene una velocidad inicial de 4 m/s. Si se aplica una fuerza de 8 N durante 3 s, ¿cuál es su velocidad final?",
                options: ["a = 4 m/s². v_f = 16 m/s.", "a = 2 m/s². v_f = 10 m/s.", "v_f = 12 m/s.", "v_f = 8 m/s."],
                correct: 0
            },
            {
                question: "Un cuerpo de 10 kg recibe una fuerza que aumenta su velocidad de 5 m/s a 25 m/s en 4 s. ¿Cuál es la fuerza neta?",
                options: ["a = 5 m/s². F = 50 N.", "a = 6.25 m/s². F = 62.5 N.", "F = 200 N.", "F = 100 N."],
                correct: 0
            },
            {
                question: "Un vehículo de 1000 kg acelera de 72 km/h a 108 km/h en 5 s. ¿Cuál es la fuerza neta?",
                options: ["Conv: 20 y 30 m/s. a=2 m/s². F=2000 N.", "Conv: 72 y 108 m/s. F=7200 N.", "F=1000 N.", "F=5400 N."],
                correct: 0
            }
        ].map(q => { 
            const correctIndex = q.correct;
            const correctOption = q.options[correctIndex];
            const newOptions = shuffleArray(q.options);
            const newCorrectIndex = newOptions.indexOf(correctOption);
            return {
                question: q.question,
                options: newOptions,
                correct: newCorrectIndex
            };
        }));

        // Detección de recarga mejorada
        window.addEventListener('load', function() {
            if (sessionStorage.getItem('SENDING_EMAIL') === 'true') {
                sessionStorage.setItem('EVALUATION_COMPLETED', 'true');
                sessionStorage.removeItem('SENDING_EMAIL');
                sessionStorage.removeItem(QUIZ_ACTIVE_KEY);
                sessionStorage.removeItem(GAME_FINISHED_KEY);
                if (sessionStorage.getItem('EVALUATION_COMPLETED') === 'true') {
                    alert('✅ Evaluación completada y enviada. No se puede repetir.');
                    document.body.innerHTML = `
                        <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #e74c3c 0%, #3498db 100%);">
                            <div style="background: white; padding: 50px; border-radius: 20px; text-align: center; max-width: 600px;">
                                <h1 style="color: #2c3e50;">✅ EVALUACIÓN COMPLETADA</h1>
                                <p style="font-size: 1.3em; color: #7f8c8d; margin: 30px 0;">
                                    Tu evaluación ha sido completada y enviada correctamente.
                                </p>
                                <p style="font-size: 1.1em; color: #95a5a6;">
                                    Esta evaluación no se puede repetir.
                                </p>
                            </div>
                        </div>
                    `;
                    return;
                }
            }
            
            if (sessionStorage.getItem('EVALUATION_COMPLETED') === 'true') {
                document.body.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #e74c3c 0%, #3498db 100%);">
                        <div style="background: white; padding: 50px; border-radius: 20px; text-align: center; max-width: 600px;">
                            <h1 style="color: #2c3e50;">✅ EVALUACIÓN COMPLETADA</h1>
                            <p style="font-size: 1.3em; color: #7f8c8d; margin: 30px 0;">
                                Esta evaluación ya fue completada y enviada.
                            </p>
                            <p style="font-size: 1.1em; color: #95a5a6;">
                                No se puede repetir la evaluación.
                            </p>
                        </div>
                    </div>
                `;
                return;
            }
            
            if (sessionStorage.getItem(QUIZ_ACTIVE_KEY) === 'true' || 
                sessionStorage.getItem(GAME_FINISHED_KEY) === 'true') {
                exitCount = maxExits;
                blockEvaluation();
            }
        });

        // Navegación
        function nextSlide() {
            if (currentSlide === 0) {
                setTimeout(() => {
                    trackingStarted = true;
                }, 1000);
            }

            const slides = document.querySelectorAll('.slide');
            slides[currentSlide].classList.remove('active');
            currentSlide++;
            if (currentSlide >= slides.length) currentSlide = slides.length - 1;
            
            // DETECTAR SI LLEGÓ A LA PANTALLA FINAL (slide 11 = resultados)
            if (currentSlide === 10) { // Slide 11 es índice 10
                onResultsPage = true;
            }
            
            slides[currentSlide].classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function prevSlide() {
            // Si está en resultados, no permitir volver atrás
            if (onResultsPage) {
                return;
            }
            
            const slides = document.querySelectorAll('.slide');
            slides[currentSlide].classList.remove('active');
            currentSlide--;
            if (currentSlide < 0) currentSlide = 0;
            slides[currentSlide].classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function saveStudentInfo() {
            const name = document.getElementById('studentName').value.trim();
            const course = document.getElementById('studentCourse').value.trim();
            const school = document.getElementById('studentSchool').value.trim();

            if (!name || !course || !school) {
                alert('⚠️ Por favor completa todos los campos antes de continuar');
                return;
            }

            window.studentName = name;
            window.studentCourse = course;
            window.studentSchool = school;

            nextSlide();
        }

        // Bloqueo de recarga mejorado
        window.addEventListener('keydown', function(event) {
            // Si está en resultados, NO bloquear recarga
            if (onResultsPage) return;
            
            if (currentSlide >= 9 && sessionStorage.getItem('SENDING_EMAIL') !== 'true') { 
                if (event.key === 'F5' || ((event.ctrlKey || event.metaKey) && event.key === 'r')) {
                    event.preventDefault();
                    if (!isBlocked) {
                        alert("🚨 ¡ALTO! Se ha detectado un intento de recarga. La evaluación será bloqueada.");
                        exitCount = maxExits; 
                        blockEvaluation(); 
                    }
                }
            }
        });

        // Detección de salida mejorada
        document.addEventListener('visibilitychange', function() {
            // Si está en resultados o enviando correo, NO contar salidas
            if (onResultsPage || sessionStorage.getItem('SENDING_EMAIL') === 'true') return;
            
            if (trackingStarted && document.hidden && !isBlocked && !gameCompleted) {
                exitCount++;
                handleExit();
            }
        });

        window.addEventListener('blur', function() {
            // Si está en resultados o enviando correo, NO contar salidas
            if (onResultsPage || sessionStorage.getItem('SENDING_EMAIL') === 'true') return;
            if (currentSlide < 9) return;
            
            if (trackingStarted && !isBlocked) {
                setTimeout(() => {
                    if (!document.hasFocus() && !onResultsPage && sessionStorage.getItem('SENDING_EMAIL') !== 'true') {
                        exitCount++;
                        handleExit();
                    }
                }, 100);
            }
        });

        function handleExit() {
            if (isBlocked || gameCompleted || onResultsPage) return;

            if (exitCount >= maxExits) {
                blockEvaluation();
            } else {
                showWarning();
            }
        }

        function showWarning() {
            const remaining = maxExits - exitCount;
            const warningPopup = document.getElementById('warningPopup');
            
            if (exitCount === 1) {
                document.getElementById('warningText').textContent = '⚠️ Primera advertencia: Has salido de la página.';
                document.getElementById('remainingExits').textContent = `⚠️ Te quedan ${remaining} oportunidades más.`;
            } else if (exitCount === 2) {
                document.getElementById('warningText').textContent = `🚨 ÚLTIMA ADVERTENCIA: Has salido ${exitCount} veces.`;
                document.getElementById('remainingExits').textContent = '🚨 ESTA ES TU ÚLTIMA OPORTUNIDAD.';
            }
            
            warningPopup.classList.add('active');
            setTimeout(() => { warningPopup.classList.remove('active'); }, 30000);
        }

        function blockEvaluation() {
            isBlocked = true;
            sessionStorage.setItem(QUIZ_ACTIVE_KEY, 'false');
            document.getElementById('finalExitCount').textContent = exitCount;
            document.getElementById('blockOverlay').classList.add('active');
            document.body.style.pointerEvents = 'none';
            document.getElementById('blockOverlay').style.pointerEvents = 'all';
        }

        // Tarjetas flashcard
        function flipCard(card) {
            card.classList.toggle('flipped');
            setTimeout(() => {
                card.classList.remove('flipped');
            }, 5000);
        }

        // JUEGO CON CONTROLES TÁCTILES DENTRO DEL CANVAS
        function startGame() {
            gameScore = 0;
            starsCollected = 0;
            playerEnergy = 100;
            gameStarted = false;
            waitingForQuestion = false;
            gameActive = false;
            roundPaused = true;
            waitingForMovement = false;
            frameCount = 0;
            obstacles = [];
            stars = [];
            player.x = 400;
            player.y = 420;
            currentQuestionIndex = 0;
            gameAnswers = [];
            gameCompleted = false;
            
            difficultyLevel = 1;
            obstacleSpeed = 3;
            obstacleFrequency = 80;
            obstacleWidth = isMobile ? 80 : 60;
            energyDecayRate = 0.15;
            
            gameStartTime = Date.now();
            roundStartTime = Date.now();
            lastStarCollectTime = Date.now();
            totalGameTime = 0;
            gameExonerated = false;
            trapActivated = false;
            keys = {};
            leftPressed = false;
            rightPressed = false;

            gameQuestions = quizQuestions; 
            
            document.getElementById('gameTitle').textContent = `🎮 Evaluación en Curso`;
            document.getElementById('gameFeedback').innerHTML = ''; 
            document.getElementById('gameMessage').textContent = `🎮 Usa las FLECHAS ← → o los BOTONES dentro del juego`;
            document.getElementById('startRoundButton').style.display = 'block';

            sessionStorage.setItem(QUIZ_ACTIVE_KEY, 'true');
            sessionStorage.setItem(GAME_FINISHED_KEY, 'false');

            nextSlide();

            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // Ajustar tamaño del canvas
            if (isMobile) {
                canvas.width = Math.min(window.innerWidth - 30, 900);
                canvas.height = 450;
                player.x = canvas.width / 2;
                player.y = canvas.height - 80;
            }

            // Definir bounds de botones dentro del canvas
            const buttonWidth = 80;
            const buttonHeight = 60;
            const buttonY = canvas.height - 70;
            
            leftButtonBounds = {
                x: 10,
                y: buttonY,
                width: buttonWidth,
                height: buttonHeight
            };
            
            rightButtonBounds = {
                x: canvas.width - buttonWidth - 10,
                y: buttonY,
                width: buttonWidth,
                height: buttonHeight
            };

            // Event listeners para teclado
            document.removeEventListener('keydown', handleKeyDown);
            document.removeEventListener('keyup', handleKeyUp);
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);

            // Event listeners para touch en el CANVAS
            canvas.removeEventListener('touchstart', handleCanvasTouchStart);
            canvas.removeEventListener('touchend', handleCanvasTouchEnd);
            canvas.removeEventListener('touchmove', handleCanvasTouchMove);
            canvas.addEventListener('touchstart', handleCanvasTouchStart, {passive: false});
            canvas.addEventListener('touchend', handleCanvasTouchEnd, {passive: false});
            canvas.addEventListener('touchmove', handleCanvasTouchMove, {passive: false});

            drawInitialScreen();
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // NUEVA FUNCIÓN: Manejar touch en el canvas - MEJORADO
        function handleCanvasTouchStart(e) {
            e.preventDefault();
            
            // Procesar todos los toques (soporte multi-touch)
            for (let i = 0; i < e.touches.length; i++) {
                const touch = e.touches[i];
                const rect = canvas.getBoundingClientRect();
                const touchX = touch.clientX - rect.left;
                const touchY = touch.clientY - rect.top;
                
                // Verificar si tocó botón izquierdo
                if (touchX >= leftButtonBounds.x && 
                    touchX <= leftButtonBounds.x + leftButtonBounds.width &&
                    touchY >= leftButtonBounds.y && 
                    touchY <= leftButtonBounds.y + leftButtonBounds.height) {
                    leftPressed = true;
                    keys['ArrowLeft'] = true;
                    
                    if (waitingForMovement) {
                        waitingForMovement = false;
                        gameActive = true;
                        document.getElementById('gameMessage').textContent = '🎮 ¡Esquiva y recoge estrellas!';
                        gameLoop();
                    }
                }
                
                // Verificar si tocó botón derecho
                if (touchX >= rightButtonBounds.x && 
                    touchX <= rightButtonBounds.x + rightButtonBounds.width &&
                    touchY >= rightButtonBounds.y && 
                    touchY <= rightButtonBounds.y + rightButtonBounds.height) {
                    rightPressed = true;
                    keys['ArrowRight'] = true;
                    
                    if (waitingForMovement) {
                        waitingForMovement = false;
                        gameActive = true;
                        document.getElementById('gameMessage').textContent = '🎮 ¡Esquiva y recoge estrellas!';
                        gameLoop();
                    }
                }
            }
        }

        function handleCanvasTouchEnd(e) {
            e.preventDefault();
            
            // Si no quedan toques, soltar ambos botones
            if (e.touches.length === 0) {
                leftPressed = false;
                rightPressed = false;
                keys['ArrowLeft'] = false;
                keys['ArrowRight'] = false;
            } else {
                // Revisar qué botones aún están siendo tocados
                let leftStillTouched = false;
                let rightStillTouched = false;
                
                for (let i = 0; i < e.touches.length; i++) {
                    const touch = e.touches[i];
                    const rect = canvas.getBoundingClientRect();
                    const touchX = touch.clientX - rect.left;
                    const touchY = touch.clientY - rect.top;
                    
                    if (touchX >= leftButtonBounds.x && 
                        touchX <= leftButtonBounds.x + leftButtonBounds.width &&
                        touchY >= leftButtonBounds.y && 
                        touchY <= leftButtonBounds.y + leftButtonBounds.height) {
                        leftStillTouched = true;
                    }
                    
                    if (touchX >= rightButtonBounds.x && 
                        touchX <= rightButtonBounds.x + rightButtonBounds.width &&
                        touchY >= rightButtonBounds.y && 
                        touchY <= rightButtonBounds.y + rightButtonBounds.height) {
                        rightStillTouched = true;
                    }
                }
                
                if (!leftStillTouched) {
                    leftPressed = false;
                    keys['ArrowLeft'] = false;
                }
                if (!rightStillTouched) {
                    rightPressed = false;
                    keys['ArrowRight'] = false;
                }
            }
        }

        function handleCanvasTouchMove(e) {
            e.preventDefault();
            // Actualizar estado de los botones mientras se mueve el dedo
            let leftCurrentlyTouched = false;
            let rightCurrentlyTouched = false;
            
            for (let i = 0; i < e.touches.length; i++) {
                const touch = e.touches[i];
                const rect = canvas.getBoundingClientRect();
                const touchX = touch.clientX - rect.left;
                const touchY = touch.clientY - rect.top;
                
                if (touchX >= leftButtonBounds.x && 
                    touchX <= leftButtonBounds.x + leftButtonBounds.width &&
                    touchY >= leftButtonBounds.y && 
                    touchY <= leftButtonBounds.y + leftButtonBounds.height) {
                    leftCurrentlyTouched = true;
                }
                
                if (touchX >= rightButtonBounds.x && 
                    touchX <= rightButtonBounds.x + rightButtonBounds.width &&
                    touchY >= rightButtonBounds.y && 
                    touchY <= rightButtonBounds.y + rightButtonBounds.height) {
                    rightCurrentlyTouched = true;
                }
            }
            
            leftPressed = leftCurrentlyTouched;
            keys['ArrowLeft'] = leftCurrentlyTouched;
            rightPressed = rightCurrentlyTouched;
            keys['ArrowRight'] = rightCurrentlyTouched;
        }

        function handleKeyDown(e) {
            keys[e.key] = true;
            
            if (waitingForMovement && (e.key === 'ArrowLeft' || e.key === 'ArrowRight')) {
                waitingForMovement = false;
                gameActive = true;
                document.getElementById('gameMessage').textContent = '🎮 ¡Esquiva y recoge estrellas!';
                gameLoop();
            }
        }

        function handleKeyUp(e) {
            keys[e.key] = false;
        }

        // NUEVA FUNCIÓN: Dibujar botones táctiles dentro del canvas
        function drawTouchButtons() {
            // Botón izquierdo
            ctx.fillStyle = leftPressed ? 'rgba(52, 152, 219, 0.9)' : 'rgba(52, 152, 219, 0.6)';
            ctx.fillRect(leftButtonBounds.x, leftButtonBounds.y, leftButtonBounds.width, leftButtonBounds.height);
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.strokeRect(leftButtonBounds.x, leftButtonBounds.y, leftButtonBounds.width, leftButtonBounds.height);
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 30px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('←', leftButtonBounds.x + leftButtonBounds.width/2, leftButtonBounds.y + leftButtonBounds.height/2);
            
            // Botón derecho
            ctx.fillStyle = rightPressed ? 'rgba(52, 152, 219, 0.9)' : 'rgba(52, 152, 219, 0.6)';
            ctx.fillRect(rightButtonBounds.x, rightButtonBounds.y, rightButtonBounds.width, rightButtonBounds.height);
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.strokeRect(rightButtonBounds.x, rightButtonBounds.y, rightButtonBounds.width, rightButtonBounds.height);
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 30px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('→', rightButtonBounds.x + rightButtonBounds.width/2, rightButtonBounds.y + rightButtonBounds.height/2);
        }

        function drawInitialScreen() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Dibujar jugador
            ctx.fillStyle = '#3498db';
            ctx.fillRect(player.x - player.width/2, player.y - player.height/2, player.width, player.height);
            ctx.fillStyle = '#fff';
            const fontSize = isMobile ? 24 : 20;
            ctx.font = `${fontSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('F=ma', player.x, player.y);
            
            // Mensaje inicial
            ctx.fillStyle = '#fff';
            ctx.shadowColor = 'rgba(255,255,255,0.8)';
            ctx.shadowBlur = 20;
            const titleSize = isMobile ? '20px' : '32px';
            ctx.font = `bold ${titleSize} Arial`;
            ctx.fillText('¡Sobrevive 10 min para exonerarte!', canvas.width/2, canvas.height/2 - 100);
            const subtitleSize = isMobile ? '16px' : '24px';
            ctx.font = `bold ${subtitleSize} Arial`;
            ctx.fillText('Presiona COMENZAR para iniciar', canvas.width/2, canvas.height/2 - 50);
            const instructSize = isMobile ? '14px' : '20px';
            ctx.font = `${instructSize} Arial`;
            ctx.fillText(isMobile ? 'Usa BOTONES en pantalla' : 'Usa ← → para moverte', canvas.width/2, canvas.height/2);
            ctx.fillStyle = '#f39c12';
            const energySize = isMobile ? '16px' : '22px';
            ctx.font = `bold ${energySize} Arial`;
            ctx.fillText('⚡ Recoge estrellas o pierdes energía', canvas.width/2, canvas.height/2 + 40);
            ctx.fillStyle = '#fff';
            const questionSize = isMobile ? '14px' : '18px';
            ctx.font = `${questionSize} Arial`;
            ctx.fillText(`${gameQuestions.length} preguntas disponibles`, canvas.width/2, canvas.height/2 + 80);
            ctx.shadowBlur = 0;
            
            // DIBUJAR BOTONES TÁCTILES
            drawTouchButtons();
        }

        function startNewRound() {
            roundPaused = false;
            waitingForMovement = true;
            gameActive = false;
            gameStarted = true;
            roundStartTime = Date.now();
            obstacles = [];
            stars = [];
            frameCount = 0;
            player.x = canvas.width / 2;
            
            playerEnergy = 60;
            lastStarCollectTime = Date.now();
            
            document.getElementById('startRoundButton').style.display = 'none';
            document.getElementById('gameMessage').textContent = isMobile ? '🎮 Toca los BOTONES para comenzar' : '🎮 Muévete (← →) para comenzar la ronda';
            
            drawWaitingScreen();
        }
        
        function drawWaitingScreen() {
            if (!waitingForMovement) return;
            
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Dibujar jugador
            ctx.fillStyle = '#3498db';
            ctx.fillRect(player.x - player.width/2, player.y - player.height/2, player.width, player.height);
            ctx.fillStyle = '#fff';
            const fontSize = isMobile ? 24 : 20;
            ctx.font = `${fontSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('F=ma', player.x, player.y);
            
            // Mensaje
            ctx.fillStyle = '#fff';
            ctx.shadowColor = 'rgba(255,255,255,0.8)';
            ctx.shadowBlur = 20;
            const messageSize = isMobile ? '16px' : '28px';
            ctx.font = `bold ${messageSize} Arial`;
            const message = isMobile ? 'Toca los BOTONES para comenzar' : 'Muévete (← →) para comenzar';
            ctx.fillText(message, canvas.width/2, canvas.height/2 - 50);
            const statsSize = isMobile ? '14px' : '22px';
            ctx.font = `${statsSize} Arial`;
            ctx.fillText(`Nivel: ${difficultyLevel} | Velocidad: ${obstacleSpeed.toFixed(1)}`, canvas.width/2, canvas.height/2);
            ctx.fillText(`⚡ Energía inicial: 60%`, canvas.width/2, canvas.height/2 + 40);
            ctx.shadowBlur = 0;
            
            // DIBUJAR BOTONES
            drawTouchButtons();
            
            if (waitingForMovement) {
                requestAnimationFrame(drawWaitingScreen);
            }
        }

        function gameLoop() {
            if (!gameActive || roundPaused) return;
            
            const tiempoTotal = Date.now() - gameStartTime;
            
            // Sistema de energía
            playerEnergy -= energyDecayRate;
            if (playerEnergy < 0) playerEnergy = 0;
            
            if (playerEnergy <= 0) {
                roundPaused = true;
                gameActive = false;
                waitingForQuestion = true;
                showLossMessage();
                return;
            }
            
            // Trampa a los 9 minutos
            if (tiempoTotal >= TRAP_TRIGGER_MS && !trapActivated) {
                obstacleSpeed = 15;
                obstacleFrequency = 20;
                obstacleWidth = isMobile ? 100 : 80;
                difficultyLevel = 10;
                energyDecayRate = 0.4;
                trapActivated = true;
                document.getElementById('gameMessage').textContent = `🚨 ¡NIVEL EXTREMO!`;
            }

            // Exoneración a los 10 minutos
            if (tiempoTotal >= EXEMPTION_TIME_MS) {
                gameExonerated = true;
                alert('🏆 ¡EXONERACIÓN LOGRADA! Has sobrevivido 10 minutos. Recibes 20/20.');
                endGame();
                return;
            }
            
            // Incremento de dificultad
            if (!trapActivated) {
                const minutoActual = Math.floor(tiempoTotal / 60000);
                if (minutoActual > difficultyLevel - 1 && minutoActual < 9) {
                    difficultyLevel = minutoActual + 1;
                    obstacleSpeed = 3 + (minutoActual * 1.5);
                    obstacleFrequency = Math.max(25, 80 - (minutoActual * 7));
                    obstacleWidth = isMobile ? Math.min(120, 80 + (minutoActual * 5)) : Math.min(100, 60 + (minutoActual * 5));
                    energyDecayRate = 0.15 + (minutoActual * 0.02);
                }
            }
            
            // Limpiar canvas
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // HUD
            const hudFontSize = isMobile ? '12px' : '16px';
            ctx.fillStyle = '#fff';
            ctx.font = hudFontSize + ' Arial';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.fillText(`Puntos: ${gameScore}`, 10, 20);
            ctx.fillText(`Nivel: ${difficultyLevel}`, 10, 36);
            ctx.fillText(`Preguntas: ${currentQuestionIndex}/20`, 10, 52);
            
            ctx.textAlign = 'right';
            const minutes = Math.floor(tiempoTotal / 60000);
            const seconds = Math.floor((tiempoTotal % 60000) / 1000);
            ctx.fillText(`Tiempo: ${minutes}:${seconds.toString().padStart(2, '0')}`, canvas.width - 10, 20);
            ctx.fillText(`Estrellas: ${starsCollected}`, canvas.width - 10, 36);
            
            // Barra de energía
            const barWidth = isMobile ? 150 : 200;
            const barHeight = isMobile ? 18 : 20;
            const barX = canvas.width / 2 - barWidth / 2;
            const barY = 10;
            
            ctx.fillStyle = '#34495e';
            ctx.fillRect(barX, barY, barWidth, barHeight);
            
            const percentage = Math.max(0, Math.round(playerEnergy));
            let energyColor = '#27ae60';
            if (percentage <= 20) {
                energyColor = '#e74c3c';
            } else if (percentage <= 40) {
                energyColor = '#f39c12';
            }
            ctx.fillStyle = energyColor;
            ctx.fillRect(barX, barY, (barWidth * percentage) / 100, barHeight);
            
            ctx.fillStyle = '#fff';
            ctx.font = isMobile ? 'bold 10px Arial' : 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(`⚡ ${percentage}%`, canvas.width / 2, barY + barHeight/2);
            
            // Mover jugador
            if (keys['ArrowLeft'] && player.x - player.width/2 > 0) {
                player.x -= player.speed;
            }
            if (keys['ArrowRight'] && player.x + player.width/2 < canvas.width) {
                player.x += player.speed;
            }
            
            // Dibujar jugador
            ctx.fillStyle = '#3498db';
            ctx.fillRect(player.x - player.width/2, player.y - player.height/2, player.width, player.height);
            ctx.fillStyle = '#fff';
            const playerTextSize = isMobile ? 24 : 20;
            ctx.font = `${playerTextSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('F=ma', player.x, player.y);
            
            frameCount++;
            
            // Crear obstáculos
            if (frameCount % obstacleFrequency === 0) {
                const x = Math.random() * (canvas.width - obstacleWidth) + obstacleWidth/2;
                obstacles.push({
                    x: x,
                    y: -30,
                    width: obstacleWidth,
                    height: isMobile ? 60 : 50,
                    speed: obstacleSpeed
                });
                
                if (difficultyLevel >= 4 && Math.random() > 0.6) {
                    const x2 = Math.random() * (canvas.width - obstacleWidth) + obstacleWidth/2;
                    obstacles.push({
                        x: x2,
                        y: -30,
                        width: obstacleWidth,
                        height: isMobile ? 60 : 50,
                        speed: obstacleSpeed
                    });
                }
            }
            
            // Crear estrellas
            const starSize = isMobile ? 35 : 25;
            if (frameCount % Math.round(obstacleFrequency * 1.2) === 0) {
                const x = Math.random() * (canvas.width - 60) + 30;
                stars.push({
                    x: x,
                    y: -30,
                    size: starSize,
                    speed: obstacleSpeed * 0.8
                });
            }

            // Actualizar obstáculos
            for (let i = obstacles.length - 1; i >= 0; i--) {
                const obs = obstacles[i];
                obs.y += obs.speed;
                
                ctx.fillStyle = '#e74c3c';
                ctx.fillRect(obs.x - obs.width/2, obs.y - obs.height/2, obs.width, obs.height);
                ctx.strokeStyle = '#c0392b';
                ctx.lineWidth = 3;
                ctx.strokeRect(obs.x - obs.width/2, obs.y - obs.height/2, obs.width, obs.height);
                
                if (Math.abs(player.x - obs.x) < (player.width + obs.width) / 2 &&
                    Math.abs(player.y - obs.y) < (player.height + obs.height) / 2) {
                    roundPaused = true;
                    gameActive = false;
                    waitingForQuestion = true;
                    showLossMessage();
                    return;
                }
                
                if (obs.y > canvas.height + 50) {
                    obstacles.splice(i, 1);
                    gameScore += 5;
                }
            }
            
            // Actualizar estrellas
            for (let i = stars.length - 1; i >= 0; i--) {
                const star = stars[i];
                star.y += star.speed;
                
                drawStar(ctx, star.x, star.y, star.size);
                
                if (Math.abs(player.x - star.x) < (player.width + star.size) / 2 &&
                    Math.abs(player.y - star.y) < (player.height + star.size) / 2) {
                    stars.splice(i, 1);
                    gameScore += 15;
                    starsCollected++;
                    
                    playerEnergy += 20;
                    if (playerEnergy > 100) playerEnergy = 100;
                    lastStarCollectTime = Date.now();
                    
                    document.getElementById('gameMessage').textContent = '⚡ ¡Energía recuperada!';
                    continue;
                }
                
                if (star.y > canvas.height + 50) {
                    stars.splice(i, 1);
                }
            }
            
            // DIBUJAR BOTONES TÁCTILES ENCIMA
            drawTouchButtons();
            
            requestAnimationFrame(gameLoop);
        }

        function drawStar(ctx, x, y, size) {
            ctx.save();
            ctx.fillStyle = '#27ae60';
            ctx.beginPath();
            for (let i = 0; i < 5; i++) {
                const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
                const xPoint = x + Math.cos(angle) * size;
                const yPoint = y + Math.sin(angle) * size;
                if (i === 0) ctx.moveTo(xPoint, yPoint);
                else ctx.lineTo(xPoint, yPoint);
                
                const angle2 = angle + Math.PI / 5;
                const xPoint2 = x + Math.cos(angle2) * (size / 2);
                const yPoint2 = y + Math.sin(angle2) * (size / 2);
                ctx.lineTo(xPoint2, yPoint2);
            }
            ctx.closePath();
            ctx.fill();
            ctx.strokeStyle = '#229954';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.restore();
        }

        function showLossMessage() {
            leftPressed = false;
            rightPressed = false;
            keys = {};
            
            const lossModal = document.getElementById('lossModal');
            const lossReason = playerEnergy <= 0 ? 
                'Tu energía llegó a 0%. Debes recoger más estrellas.' : 
                'Has chocado con un obstáculo.';
            
            document.getElementById('lossReason').textContent = lossReason;
            
            document.getElementById('overlay').classList.add('active');
            lossModal.classList.add('active');
        }
        
        function showQuestionAfterLoss() {
            document.getElementById('lossModal').classList.remove('active');
            showGameQuestion();
        }

        function showGameQuestion() {
            if (currentQuestionIndex >= gameQuestions.length) {
                endGame();
                return;
            }

            const question = gameQuestions[currentQuestionIndex];
            
            document.getElementById('questionModal').classList.add('active');
            document.getElementById('questionText').textContent = question.question;
            
            const optionsDiv = document.getElementById('optionsContainer');
            optionsDiv.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'answer-option';
                button.textContent = option;
                button.onclick = () => answerGameQuestion(index);
                optionsDiv.appendChild(button);
            });
        }

        function answerGameQuestion(selectedIndex) {
            const question = gameQuestions[currentQuestionIndex];
            const isCorrect = selectedIndex === question.correct;
            
            gameAnswers.push({
                question: question.question,
                selected: selectedIndex,
                correct: question.correct,
                options: question.options,
                isCorrect: isCorrect
            });
            
            if (isCorrect) {
                gameScore += 50;
            }
            
            currentQuestionIndex++;
            
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('questionModal').classList.remove('active');
            
            if (currentQuestionIndex >= 20) {
                showGameOver();
            } else {
                player.x = canvas.width / 2;
                obstacles = [];
                stars = [];
                frameCount = 0;
                waitingForQuestion = false;
                
                leftPressed = false;
                rightPressed = false;
                keys = {};
                
                document.getElementById('startRoundButton').style.display = 'block';
                document.getElementById('gameMessage').textContent = `✅ Respuesta registrada. Nivel ${difficultyLevel} - Presiona COMENZAR`;
            }
        }

        function showGameOver() {
            gameActive = false;
            roundPaused = true;
            gameCompleted = true;
            sessionStorage.setItem(GAME_FINISHED_KEY, 'true');
            sessionStorage.setItem(QUIZ_ACTIVE_KEY, 'false');
            
            leftPressed = false;
            rightPressed = false;
            keys = {};
            
            const correctCount = gameAnswers.filter(a => a.isCorrect).length;
            
            document.getElementById('gameOverScore').textContent = `${correctCount}`;
            document.getElementById('overlay').classList.add('active');
            document.getElementById('gameOverModal').classList.add('active');
        }

        function endGame() {
            gameActive = false;
            roundPaused = true;
            gameCompleted = true;
            sessionStorage.setItem(GAME_FINISHED_KEY, 'true');
            sessionStorage.setItem(QUIZ_ACTIVE_KEY, 'false');

            if (gameExonerated) {
                let totalQuestions = quizQuestions.length;
                let answeredCount = gameAnswers.length;
                
                for (let i = answeredCount; i < totalQuestions; i++) {
                    const question = gameQuestions[i];
                    gameAnswers.push({
                        question: question.question,
                        selected: question.correct,
                        correct: question.correct,
                        options: question.options,
                        isCorrect: true
                    });
                }
            }
            
            showGameOver();
        }

        function showFinalResults() {
            document.getElementById('gameOverModal').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            
            const name = window.studentName || 'No especificado';
            const course = window.studentCourse || 'No especificado';
            const school = window.studentSchool || 'No especificado';
            const totalQuestions = 20;
            const correctCount = gameAnswers.filter(a => a.isCorrect).length;
            const percentage = Math.round((correctCount / totalQuestions) * 100);

            document.getElementById('studentNameDisplay').textContent = `Nombre: ${name}`;
            document.getElementById('studentCourseDisplay').textContent = `Curso: ${course}`;
            document.getElementById('studentSchoolDisplay').textContent = `Colegio: ${school}`;
            
            const exitWarning = exitCount >= maxExits ? '🚫 BLOQUEADA' : exitCount > 0 ? '⚠️ Salidas detectadas' : '✅ Sin salidas';
            document.getElementById('exitCountDisplay').textContent = `Salidas: ${exitCount} (${exitWarning})`;

            document.getElementById('finalGameQuestions').textContent = `${gameAnswers.length}/${totalQuestions}`;
            document.getElementById('finalCorrectCount').textContent = `${correctCount}`;
            document.getElementById('exonerationStatus').textContent = gameExonerated ? '🏆 ¡EXONERADO!' : 'Prueba completada';
            
            document.getElementById('totalScore').textContent = `${correctCount}/${totalQuestions} (${percentage}%)`;
            
            let message = '';
            if (percentage >= 90) {
                message = '🌟 ¡Excelente! Dominas las Leyes de Newton.';
            } else if (percentage >= 75) {
                message = '👏 ¡Muy bien! Buen conocimiento.';
            } else if (percentage >= 60) {
                message = '👍 Buen trabajo, sigue practicando.';
            } else {
                message = '💪 Necesitas repasar más. ¡No te rindas!';
            }
            
            document.getElementById('finalMessage').textContent = message;
            document.getElementById('quizFeedback').innerHTML = generateFinalDetailsHTML();
            
            nextSlide();
        }
        
        function generateFinalDetailsHTML() {
            let html = '<h3 style="color: #2c3e50; border-bottom: 3px solid #2c3e50; padding-bottom: 15px; margin-bottom: 25px; font-size: 2em;">📝 Resultados de Respuestas</h3>';
            
            gameAnswers.forEach((answer, index) => {
                const resultClass = answer.isCorrect ? 'correct' : 'incorrect';
                const resultText = answer.isCorrect ? '✅ Correcta' : '❌ Incorrecta';
                
                html += `<div class="feedback-item ${resultClass}">
                    <h4 style="font-size: 1.25em; margin-bottom: 10px;">Pregunta ${index + 1}: ${resultText}</h4>
                </div>`;
            });
            return html;
        }

        function sendResultsByEmail() {
            sessionStorage.setItem('SENDING_EMAIL', 'true');
            
            const studentName = document.getElementById('studentNameDisplay').textContent;
            const studentCourse = document.getElementById('studentCourseDisplay').textContent;
            const studentSchool = document.getElementById('studentSchoolDisplay').textContent;
            
            const scoreTotal = document.getElementById('totalScore').textContent;
            const correctCount = document.getElementById('finalCorrectCount').textContent;
            const exemption = document.getElementById('exonerationStatus').textContent;
            const message = document.getElementById('finalMessage').textContent;
            const exitCountDisplay = document.getElementById('exitCountDisplay').textContent;
            
            const subject = "Resultados - Leyes de Newton: Desafío Integrado";
            const body = `
RESULTADOS DEL ESTUDIANTE
========================

${studentName}
${studentCourse}
${studentSchool}

MONITOREO:
----------
${exitCountDisplay}

PUNTUACIONES:
-------------
🏆 ${exemption}
✅ Correctas: ${correctCount}/20
✨ TOTAL: ${scoreTotal}

${message}

NOTA: Adjunto pantallazo de los resultados completos.
            `;
            
            const mailtoLink = `mailto:andres.5050@hotmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            alert('✅ Se abrirá tu programa de correo.\n\n⚠️ IMPORTANTE:\n1. Toma pantallazo de los resultados\n2. Adjunta el pantallazo al correo\n3. Envía el correo\n\n🔴 DESPUÉS DE ENVIAR, LA EVALUACIÓN SE CERRARÁ PERMANENTEMENTE.');
            
            window.location.href = mailtoLink;
            
            setTimeout(() => {
                sessionStorage.setItem('EVALUATION_COMPLETED', 'true');
                sessionStorage.removeItem('SENDING_EMAIL');
                sessionStorage.removeItem(QUIZ_ACTIVE_KEY);
                sessionStorage.removeItem(GAME_FINISHED_KEY);
                
                document.body.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #e74c3c 0%, #3498db 100%);">
                        <div style="background: white; padding: 50px; border-radius: 20px; text-align: center; max-width: 600px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                            <h1 style="color: #27ae60; font-size: 3em;">✅ EVALUACIÓN ENVIADA</h1>
                            <p style="font-size: 1.5em; color: #2c3e50; margin: 30px 0; font-weight: bold;">
                                Gracias por completar la evaluación
                            </p>
                            <p style="font-size: 1.2em; color: #7f8c8d;">
                                Tu profesor recibirá los resultados por correo.
                            </p>
                            <hr style="margin: 30px 0; border: 1px solid #ecf0f1;">
                            <p style="font-size: 1em; color: #95a5a6;">
                                Esta ventana puede cerrarse. La evaluación ha finalizado.
                            </p>
                        </div>
                    </div>
                `;
            }, 3000);
        }
    </script>
</body>
</html>